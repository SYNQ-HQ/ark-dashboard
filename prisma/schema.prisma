// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  walletAddress String    @unique
  username      String    @unique
  bio           String?
  profileImageUrl String?
  points        Int       @default(0)
  isEligible    Boolean   @default(false)
  lastSpin      DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  missions      UserMission[]
  redemptions   Redemption[]
  streak        Streak?
  badges        UserBadge[]
  role          Role      @default(USER)
  isBanned      Boolean   @default(false)
  lastUsernameChange DateTime?
  holdingStartedAt DateTime? // Tracks when user first met the $250 holding requirement
  lastBalanceCheck DateTime? // Last time we checked their balance
  balanceHistory BalanceSnapshot[] // Historical balance snapshots
  activities    UserActivity[]
  
  // ARK Features
  timezone      String?
  lastRankCheck DateTime?
  arkRank       ArkRank   @default(RECRUIT)
  oathAcceptedAt DateTime?
  oathDurationSeconds Int?
  
  checkInLogs   CheckInLog[]
  rankHistory   RankHistory[]
}

model UserActivity {
  id          String   @id @default(cuid())
  userId      String
  type        String   // "CHECK_IN", "MISSION", "REWARD", etc.
  description String
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}


enum ArkRank {
  RECRUIT
  SENTINEL
  OPERATIVE
  VANGUARD
  CAPTAIN
  COMMANDER
  HIGH_GUARDIAN
}

model BalanceSnapshot {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance     Float    // ACT token balance
  balanceUsd  Float    // USD value at time of snapshot
  checkedAt   DateTime @default(now())
  source      String   @default("MANUAL") // "MANUAL", "CRON", "AUTO"
  
  @@index([userId, checkedAt])
  @@index([checkedAt]) // For cleanup queries
}

enum Role {
  USER
  ADMIN
}

model Mission {
  id          String   @id @default(cuid())
  title       String
  description String
  type        String // SOCIAL, ONCHAIN, REFERRAL
  points      Int
  frequency   String // DAILY, ONETIME
  imageUrl    String?
  
  userMissions UserMission[]
}

model UserMission {
  id          String    @id @default(cuid())
  userId      String
  missionId   String
  status      String // PENDING, COMPLETED
  completedAt DateTime?

  user    User    @relation(fields: [userId], references: [id])
  mission Mission @relation(fields: [missionId], references: [id])
  
  @@unique([userId, missionId]) // Ensure user can have only one active record per mission (unless recurring logic handled elsewhere)
}

model Reward {
  id          String @id @default(cuid())
  name        String
  description String
  cost        Int
  stock       Int? // Optional stock limit
  imageUrl    String?

  redemptions Redemption[]
}

model Redemption {
  id         String   @id @default(cuid())
  userId     String
  rewardId   String
  redeemedAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  reward Reward @relation(fields: [rewardId], references: [id])
}

model Streak {
  id          String   @id @default(cuid())
  userId      String   @unique
  currentStreak Int    @default(0)
  lastCheckIn DateTime @default(now())

  longestStreak Int    @default(0)
  lastFrozenAt  DateTime?

  user User @relation(fields: [userId], references: [id])
}

model CheckInLog {
  id        String   @id @default(cuid())
  userId    String
  date      DateTime @default(now())
  points    Int      @default(10)
  
  user      User     @relation(fields: [userId], references: [id])
}

model RankHistory {
  id         String   @id @default(cuid())
  userId     String
  rank       ArkRank
  promotedAt DateTime @default(now())
  
  user       User     @relation(fields: [userId], references: [id])
}

model Badge {
  id          String @id @default(cuid())
  name        String
  description String?
  icon        String // Emoji or URL
  displayOrder Int     @default(0)
  
  userBadges  UserBadge[]
}

model UserBadge {
  id String @id @default(cuid())
  userId String
  badgeId String
  awardedAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id])
  badge Badge @relation(fields: [badgeId], references: [id])

  @@unique([userId, badgeId])
}

model ImpactStory {
  id String @id @default(cuid())
  slug String @unique // SEO-friendly URL
  title String
  description String
  imageUrl String?
  location String?
  date DateTime?
  raised Float? @default(0)
  goal Float?
  supporters Int? @default(0)
  status String? @default("active")
  createdAt DateTime @default(now())
}

model Event {
  id          String   @id @default(cuid())
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime
  multiplier  Float    @default(1.0) // 1.5x, 2.0x etc.
  status      String   @default("SCHEDULED") // SCHEDULED, ACTIVE, COMPLETED, CANCELLED
  type        String   @default("BONUS") // BONUS, EVENT, ETC
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
